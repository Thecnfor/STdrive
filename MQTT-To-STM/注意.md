## å›ç­”ä½ çš„ä¸¤ä¸ªé—®é¢˜ï¼š

### é—®é¢˜ 1ï¼šå¯ä»¥è®¾ç½®å¤šä¸ª `MQTT_SetMessageHandler` å—ï¼Ÿ

âŒ **ä¸å¯ä»¥ï¼** æ ¹æ®å½“å‰çš„ API è®¾è®¡ï¼Œåªèƒ½è®¾ç½®**ä¸€ä¸ª**å›è°ƒå‡½æ•°ã€‚

```cpp
// âŒ é”™è¯¯ç”¨æ³•ï¼šåé¢çš„ä¼šè¦†ç›–å‰é¢çš„
MQTT_SetMessageHandler(handle_led);
MQTT_SetMessageHandler(handle_relay);  // è¿™ä¸ªä¼šè¦†ç›–ä¸Šé¢çš„
MQTT_SetMessageHandler(handle_sensor); // æœ€ç»ˆåªæœ‰è¿™ä¸ªç”Ÿæ•ˆ
```

**ä¸ºä»€ä¹ˆï¼Ÿ** å› ä¸ºå†…éƒ¨å®ç°é€šå¸¸æ˜¯è¿™æ ·çš„ï¼š

```cpp
// conn.c å†…éƒ¨
static MQTT_MessageHandler message_handler = NULL;  // åªæœ‰ä¸€ä¸ªå˜é‡

void MQTT_SetMessageHandler(MQTT_MessageHandler handler) {
    message_handler = handler;  // èµ‹å€¼ï¼Œä¼šè¦†ç›–ä¹‹å‰çš„
}

void MQTT_Service(void) {
    // ...
    if (æ”¶åˆ°æ¶ˆæ¯ && message_handler != NULL) {
        message_handler(topic, payload);  // åªè°ƒç”¨è¿™ä¸€ä¸ª
    }
}
```

---

### âœ… æ­£ç¡®åšæ³•ï¼šä¸€ä¸ªå›è°ƒå¤„ç†æ‰€æœ‰æ¶ˆæ¯

```cpp
// âœ… æ­£ç¡®ï¼šåœ¨ä¸€ä¸ªå›è°ƒå‡½æ•°é‡Œå¤„ç†æ‰€æœ‰ä¸»é¢˜
void on_message_received(const char *topic, const char *payload) {
    // æ ¹æ®ä¸åŒçš„ä¸»é¢˜ï¼Œæ‰§è¡Œä¸åŒçš„é€»è¾‘
    
    if (strcmp(topic, "cmd/led") == 0) {
        // å¤„ç† LED
        handle_led(payload);
    }
    else if (strcmp(topic, "cmd/relay") == 0) {
        // å¤„ç†ç»§ç”µå™¨
        handle_relay(payload);
    }
    else if (strcmp(topic, "sensor/temp") == 0) {
        // å¤„ç†æ¸©åº¦æ•°æ®
        handle_temperature(payload);
    }
    else if (strncmp(topic, "config/", 7) == 0) {
        // å¤„ç†æ‰€æœ‰ config/ å¼€å¤´çš„ä¸»é¢˜
        handle_config(topic, payload);
    }
    else {
        // æœªçŸ¥ä¸»é¢˜
        printf("æ”¶åˆ°æœªçŸ¥ä¸»é¢˜: %s\n", topic);
    }
}

// è¾…åŠ©å‡½æ•°
void handle_led(const char *payload) {
    if (strcmp(payload, "on") == 0) {
        HAL_GPIO_WritePin(LED_GPIO_Port, LED_Pin, GPIO_PIN_SET);
    } else if (strcmp(payload, "off") == 0) {
        HAL_GPIO_WritePin(LED_GPIO_Port, LED_Pin, GPIO_PIN_RESET);
    }
}

void handle_relay(const char *payload) {
    // ç»§ç”µå™¨é€»è¾‘
}

void handle_temperature(const char *payload) {
    float temp = atof(payload);
    display_on_screen(temp);
}

int main(void) {
    MQTT_Start();
    MQTT_SetMessageHandler(on_message_received);  // åªè®¾ç½®ä¸€æ¬¡
    
    // è®¢é˜…å¤šä¸ªä¸»é¢˜
    MQTT_Subscribe("cmd/led");
    MQTT_Subscribe("cmd/relay");
    MQTT_Subscribe("sensor/temp");
    MQTT_Subscribe("config/#");  // é€šé…ç¬¦
    
    while (1) {
        MQTT_Service();
        HAL_Delay(50);
    }
}
```

---

## é—®é¢˜ 2ï¼š`MQTT_Service()` ä¼šè‡ªåŠ¨è§¦å‘é€»è¾‘å—ï¼Ÿ

âœ… **æ˜¯çš„ï¼å®Œå…¨æ­£ç¡®ï¼**

### è‡ªåŠ¨è§¦å‘æµç¨‹

```
å…¶ä»–è®¾å¤‡å‘é€: MQTT_Publish("cmd/led", "on")
        â†“
æ¶ˆæ¯åˆ°è¾¾ MQTT æœåŠ¡å™¨
        â†“
æœåŠ¡å™¨æ¨é€ç»™ä½ çš„è®¾å¤‡ï¼ˆå› ä¸ºä½ è®¢é˜…äº† "cmd/led"ï¼‰
        â†“
æ•°æ®åˆ°è¾¾ ESP8266
        â†“
ESP8266 é€šè¿‡ UART å‘ç»™ STM32
        â†“
ä½ çš„ while å¾ªç¯æ‰§è¡Œåˆ°: MQTT_Service()  â† è¿™é‡Œï¼
        â†“
MQTT_Service() å†…éƒ¨ï¼š
  1. ä» UART è¯»æ•°æ®
  2. è§£æå‡º: topic="cmd/led", payload="on"
  3. æ£€æŸ¥æ˜¯å¦è®¾ç½®äº†å›è°ƒï¼ˆä½ è®¾ç½®äº†ï¼‰
  4. è‡ªåŠ¨è°ƒç”¨: on_message_received("cmd/led", "on")  â† è‡ªåŠ¨è§¦å‘ï¼
        â†“
ä½ çš„å›è°ƒå‡½æ•°æ‰§è¡Œ:
  if (strcmp(topic, "cmd/led") == 0) {
      if (strcmp(payload, "on") == 0) {
          å¼€ç¯();  â† ä½ çš„é€»è¾‘è¢«æ‰§è¡Œ
      }
  }
```

### å®é™…æ¼”ç¤º

```cpp
void on_message(const char *topic, const char *payload) {
    printf("ğŸ”” æ”¶åˆ°æ¶ˆæ¯ï¼ä¸»é¢˜: %s, å†…å®¹: %s\n", topic, payload);
    
    if (strcmp(topic, "cmd/led") == 0) {
        if (strcmp(payload, "on") == 0) {
            printf("âœ… æ‰§è¡Œå¼€ç¯é€»è¾‘\n");
            HAL_GPIO_WritePin(LED_GPIO_Port, LED_Pin, GPIO_PIN_SET);
        }
    }
}

int main(void) {
    MQTT_Start();
    MQTT_SetMessageHandler(on_message);
    MQTT_Subscribe("cmd/led");
    
    printf("å¼€å§‹ä¸»å¾ªç¯...\n");
    
    while (1) {
        printf("â° è°ƒç”¨ MQTT_Service()...\n");
        MQTT_Service();  // â† å¦‚æœæœ‰æ¶ˆæ¯ï¼Œä¼šåœ¨è¿™é‡Œè‡ªåŠ¨è§¦å‘ on_message()
        
        printf("ğŸ’¤ ç­‰å¾… 50ms\n");
        HAL_Delay(50);
    }
}
```

### è¾“å‡ºç¤ºä¾‹

```
å¼€å§‹ä¸»å¾ªç¯...
â° è°ƒç”¨ MQTT_Service()...
ğŸ’¤ ç­‰å¾… 50ms
â° è°ƒç”¨ MQTT_Service()...
ğŸ’¤ ç­‰å¾… 50ms
â° è°ƒç”¨ MQTT_Service()...
ğŸ”” æ”¶åˆ°æ¶ˆæ¯ï¼ä¸»é¢˜: cmd/led, å†…å®¹: on  â† è‡ªåŠ¨è§¦å‘ï¼
âœ… æ‰§è¡Œå¼€ç¯é€»è¾‘
ğŸ’¤ ç­‰å¾… 50ms
â° è°ƒç”¨ MQTT_Service()...
ğŸ’¤ ç­‰å¾… 50ms
```

---

## ğŸ¯ æ ¸å¿ƒç†è§£

### 1. **ä¸€ä¸ªå›è°ƒå¤„ç†æ‰€æœ‰ä¸»é¢˜**

```cpp
// è¿™ä¸ªå‡½æ•°ä¼šæ”¶åˆ°æ‰€æœ‰è®¢é˜…ä¸»é¢˜çš„æ¶ˆæ¯
void on_message(const char *topic, const char *payload) {
    // ä½ è®¢é˜…äº† 3 ä¸ªä¸»é¢˜ï¼š
    // - cmd/led
    // - cmd/relay
    // - sensor/temp
    
    // ä»»ä½•ä¸€ä¸ªä¸»é¢˜æœ‰æ¶ˆæ¯ï¼Œéƒ½ä¼šè°ƒç”¨è¿™ä¸ªå‡½æ•°
    // ä½ éœ€è¦ç”¨ if/else åˆ¤æ–­æ˜¯å“ªä¸ªä¸»é¢˜
}
```

### 2. **`MQTT_Service()` æ˜¯æ¶ˆæ¯å¤„ç†å¼•æ“**

```cpp
while (1) {
    MQTT_Service();  // è¿™ä¸€è¡Œåšäº†æ‰€æœ‰é­”æ³•ï¼š
                     // - æ¥æ”¶æ•°æ®
                     // - è§£ææ¶ˆæ¯
                     // - è‡ªåŠ¨è°ƒç”¨ä½ çš„å›è°ƒ
                     // - å‘é€å¿ƒè·³
                     // - æ£€æµ‹è¿æ¥
    
    // ä½ ä¸éœ€è¦æ‰‹åŠ¨æ£€æŸ¥æ˜¯å¦æœ‰æ¶ˆæ¯
    // ä¸éœ€è¦æ‰‹åŠ¨è§£æ
    // ä¸€åˆ‡éƒ½æ˜¯è‡ªåŠ¨çš„ï¼
    
    HAL_Delay(50);
}
```

### 3. **å®Œæ•´çš„æ¶ˆæ¯æµ**

```cpp
// è®¾å¤‡ Aï¼ˆæ¸©åº¦ä¼ æ„Ÿå™¨ï¼‰
MQTT_Publish("sensor/temp", "25.5");  // å‘é€
        â†“
// MQTT æœåŠ¡å™¨
        â†“
// è®¾å¤‡ Bï¼ˆä½ çš„ STM32ï¼‰
MQTT_Subscribe("sensor/temp");  // å·²è®¢é˜…
MQTT_SetMessageHandler(on_msg); // å·²è®¾ç½®å›è°ƒ

while (1) {
    MQTT_Service();  // â† æ”¶åˆ°æ¶ˆæ¯ï¼Œè‡ªåŠ¨è°ƒç”¨ on_msg("sensor/temp", "25.5")
    HAL_Delay(50);
}

void on_msg(const char *topic, const char *payload) {
    // è‡ªåŠ¨æ‰§è¡Œï¼
    float temp = atof(payload);  // 25.5
    display(temp);
}
```

---

## æ€»ç»“

âœ… **åªèƒ½è®¾ç½®ä¸€ä¸ªå›è°ƒï¼Œä½†å¯ä»¥åœ¨å›è°ƒé‡Œå¤„ç†å¤šä¸ªä¸»é¢˜**  
âœ… **`MQTT_Service()` ä¼šè‡ªåŠ¨è§¦å‘ä½ çš„å›è°ƒé€»è¾‘**  
âœ… **ä½ åªéœ€è¦ï¼šè®¾ç½®å›è°ƒ â†’ è®¢é˜…ä¸»é¢˜ â†’ å¾ªç¯è°ƒç”¨ ServiceTick â†’ ç­‰å¾…è‡ªåŠ¨è§¦å‘**

---

### è¡¥å……ï¼šå®šæ—¶å™¨é©±åŠ¨ä¸æ¨¡å¼é€‰æ‹©

- å¦‚æœåœ¨å·¥ç¨‹ä¸­å®šä¹‰äº† `MQTT_TIM_HANDLE`ï¼ŒæœåŠ¡ä¾‹ç¨‹ä¼šåœ¨å®šæ—¶å™¨ä¸­æ–­ä¸­è‡ªåŠ¨è§¦å‘ï¼Œæ— éœ€åœ¨ä¸»å¾ªç¯ä¸­è°ƒç”¨ `MQTT_Service()`ã€‚
- å›è°ƒå¼æ¥æ”¶ä¸è½®è¯¢å¼æ¥æ”¶ä¸è¦æ··ç”¨ï¼šä½¿ç”¨å›è°ƒæ—¶è¯·è°ƒç”¨ `MQTT_SetMessageHandler(handler)` å¹¶ä¾èµ–æœåŠ¡ä¾‹ç¨‹è§¦å‘ï¼›è‹¥æ”¹ç”¨è½®è¯¢ï¼Œè¯·ç›´æ¥åœ¨å¾ªç¯ä¸­è°ƒç”¨ `MQTT_Process(...)` æ‹‰å–æ¶ˆæ¯ï¼Œå¹¶ä¸è¦è®¾ç½®å›è°ƒã€‚

---

## ğŸ†• è®¢é˜…ç®¡ç†æ•™ç¨‹

### 1. æ³¨å†Œè®¢é˜…ï¼ˆè‡ªåŠ¨é‡è¿ï¼‰

ç°åœ¨ `MQTT_Subscribe` æ›´åŠ æ™ºèƒ½ã€‚å³ä½¿ MQTT è¿˜æ²¡è¿æ¥ï¼Œä½ ä¹Ÿå¯ä»¥è°ƒç”¨å®ƒï¼å®ƒä¼šè‡ªåŠ¨è®°å½•ä½ çš„è®¢é˜…æ„å›¾ï¼Œç­‰åˆ°è¿æ¥å»ºç«‹åè‡ªåŠ¨å‘é€ã€‚

**ç‰¹æ€§ï¼š**
*   **æå‰æ³¨å†Œ**ï¼šå¯ä»¥åœ¨ `MQTT_Start` ä¹‹å‰æˆ–ä¹‹åè°ƒç”¨ã€‚
*   **æ–­çº¿é‡è¿**ï¼šå¦‚æœç½‘ç»œæ–­å¼€ï¼Œé‡è¿æˆåŠŸåä¼šè‡ªåŠ¨é‡æ–°è®¢é˜…æ‰€æœ‰å·²æ³¨å†Œçš„ä¸»é¢˜ã€‚
*   **è‡ªåŠ¨ç®¡ç†**ï¼šä¸éœ€è¦ä½ è‡ªå·±åˆ¤æ–­æ˜¯å¦è¿æ¥ï¼Œåªç®¡æ³¨å†Œã€‚

**ç¤ºä¾‹ä»£ç ï¼š**

```cpp
/* 1. åˆå§‹åŒ– */
MQTT_Start();
MQTT_SetMessageHandler(on_message);

/* 2. æ³¨å†Œä½ æ„Ÿå…´è¶£çš„ä¸»é¢˜ */
/* å³ä½¿æ­¤æ—¶è¿˜æ²¡æœ‰è¿ä¸ŠæœåŠ¡å™¨ï¼Œä¹Ÿä¼šå…ˆè®°å½•ä¸‹æ¥ */
MQTT_Subscribe("cmd/led");
MQTT_Subscribe("cmd/motor");
MQTT_Subscribe("settings/#");

/* 3. è¿›å…¥ä¸»å¾ªç¯ */
while (1) {
    /* æ‰€æœ‰çš„è®¢é˜…å‘é€ã€å¿ƒè·³ç»´æŒã€é‡è¿è¡¥å‘éƒ½åœ¨è¿™é‡Œè‡ªåŠ¨å¤„ç† */
    MQTT_Service();
    HAL_Delay(50);
}
```

### 2. å–æ¶ˆè®¢é˜…

å¦‚æœä½ ä¸å†éœ€è¦æ¥æ”¶æŸä¸ªä¸»é¢˜çš„æ¶ˆæ¯ï¼Œå¯ä»¥ä½¿ç”¨ `MQTT_Unsubscribe`ã€‚

**ä½œç”¨ï¼š**
1.  å‘æœåŠ¡å™¨å‘é€ UNSUBSCRIBE æŠ¥æ–‡ï¼Œåœæ­¢æ¥æ”¶è¯¥ä¸»é¢˜ã€‚
2.  ä»æœ¬åœ°è‡ªåŠ¨é‡è¿åˆ—è¡¨ä¸­ç§»é™¤ï¼Œä¸‹æ¬¡é‡è¿ä¸ä¼šå†è‡ªåŠ¨è®¢é˜…å®ƒã€‚

**ç¤ºä¾‹ä»£ç ï¼š**

```cpp
void stop_listening_motor(void) {
    printf("ä¸å†ç›‘å¬ç”µæœºæŒ‡ä»¤...\r\n");
    MQTT_Unsubscribe("cmd/motor");
}

/* å³ä½¿æ–­ç½‘äº†ï¼Œè°ƒç”¨å®ƒä¹Ÿä¼šä»æœ¬åœ°åˆ—è¡¨ä¸­ç§»é™¤ï¼Œç¡®ä¿ä¸‹æ¬¡è¿ä¸Šä¸ä¼šå†è®¢ */
```

### 3. API å‚è€ƒ

| å‡½æ•° | æè¿° |
| :--- | :--- |
| `bool MQTT_Subscribe(const char *topic)` | æ³¨å†Œä¸€ä¸ªè®¢é˜…ä¸»é¢˜ã€‚å¦‚æœåˆ—è¡¨å·²æ»¡ï¼ˆé»˜è®¤10ä¸ªï¼‰ä¼šè¿”å› falseã€‚ |
| `bool MQTT_Unsubscribe(const char *topic)` | å–æ¶ˆè®¢é˜…ä¸€ä¸ªä¸»é¢˜ã€‚ |

**æ³¨æ„ï¼š** é»˜è®¤æœ€å¤§æ”¯æŒ 10 ä¸ªè®¢é˜…ä¸»é¢˜ã€‚å¦‚æœéœ€è¦æ›´å¤šï¼Œè¯·ä¿®æ”¹ `conn.c` ä¸­çš„ `#define MAX_SUBSCRIPTIONS 10`ã€‚
